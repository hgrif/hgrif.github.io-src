<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2017-08-11">

<title>Airflow Tutorial – Henk Griffioen</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-bfe8143d3efc8a2443c1fbfe9d6b08df.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Henk Griffioen</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Writing</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resume.html"> 
<span class="menu-text">Resume</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Airflow Tutorial</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 11, 2017</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">1. Setup</a></li>
  <li><a href="#workflows" id="toc-workflows" class="nav-link" data-scroll-target="#workflows">2. Workflows</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">3. Exercises</a></li>
  <li><a href="#resources" id="toc-resources" class="nav-link" data-scroll-target="#resources">4. Resources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p><a href="https://airflow.incubator.apache.org/">Airflow</a> is a scheduler for workflows such as data pipelines, similar to <a href="https://github.com/spotify/luigi">Luigi</a> and <a href="https://oozie.apache.org/">Oozie</a>.</p>
<p>This tutorial is loosely based on the Airflow tutorial in the <a href="https://pythonhosted.org/airflow/tutorial.html">official documentation</a>. It will walk you through the basics of setting up Airflow and creating an Airflow workflow, and it will give you some practical tips. A (possibly) more up-to-date version of this blog can be found in my <a href="https://github.com/hgrif/airflow-tutorial">git repo</a>.</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">1. Setup</h2>
<p>Setting up a basic configuration of Airflow is pretty straightforward. After installing the Python package, we’ll need a database to store some data and start the core Airflow services.</p>
<p>You can skip this section if Airflow is already set up. Make sure that you can run <code>airflow</code> commands, know where to put your DAGs and have access to the web UI.</p>
<section id="install-airflow" class="level4">
<h4 class="anchored" data-anchor-id="install-airflow">Install Airflow</h4>
<p>Airflow is installable with <code>pip</code> via a simple <code>pip install apache-airflow</code>. Either use a separate Python virtual environment or install it in your default python environment.</p>
<p>To use the conda virtual environment as defined in <code>environment.yml</code> from my <a href="https://github.com/hgrif/airflow-tutorial">git repo</a>:</p>
<ul>
<li>Install <a href="http://conda.pydata.org/miniconda.html">miniconda</a>.</li>
<li>Make sure that conda is on your path:</li>
</ul>
<pre class="{bash}"><code>$ which conda
~/miniconda3/bin/conda</code></pre>
<ul>
<li>Create the virtual environment from <code>environment.yml</code>:</li>
</ul>
<pre class="{bash}"><code>$ conda env create -f environment.yml</code></pre>
<ul>
<li>Activate the virtual environment:</li>
</ul>
<pre class="{bash}"><code>$ source activate airflow-tutorial</code></pre>
<p>You should now have an (almost) working Airflow installation.</p>
<p>Alternatively, install Airflow yourself by running:</p>
<pre class="{bash}"><code>$ pip install apache-airflow</code></pre>
<p>Airflow used to be packaged as <code>airflow</code> but is packaged as <code>apache-airflow</code> since version 1.8.1. Make sure that you install any extra packages with the right Python package: e.g.&nbsp;use <code>pip install apache-airflow[dask]</code> if you’ve installed <code>apache-airflow</code> and do not use <code>pip install airflow[dask]</code>. Leaving out the prefix <code>apache-</code> will install an old version of Airflow next to your current version, leading to a world of hurt.</p>
<p>You may run into problems if you don’t have the right binaries or Python packages installed for certain backends or operators. When specifying support for e.g.&nbsp;PostgreSQL when installing extra Airflow packages, make sure the database is installed; do a <code>brew install postgresql</code> or <code>apt-get install postgresql</code> before the <code>pip install apache-airflow[postgres]</code>. Similarly, when running into HiveOperator errors, do a <code>pip install apache-airflow[hive]</code> and make sure you can use Hive.</p>
</section>
<section id="run-airflow" class="level4">
<h4 class="anchored" data-anchor-id="run-airflow">Run Airflow</h4>
<p>Before you can use Airflow you have to initialize its database. The database contains information about historical &amp; running workflows, connections to external data sources, user management, etc. Once the database is set up, Airflow’s UI can be accessed by running a web server and workflows can be started.</p>
<p>The default database is a SQLite database, which is fine for this tutorial. In a production setting you’ll probably be using something like MySQL or PostgreSQL. You’ll probably want to back it up as this database stores the state of everything related to Airflow.</p>
<p>Airflow will use the directory set in the environment variable <code>AIRFLOW_HOME</code> to store its configuration and our SQlite database. This directory will be used after your first Airflow command. If you don’t set the environment variable <code>AIRFLOW_HOME</code>, Airflow will create the directory <code>~/airflow/</code> to put its files in.</p>
<p>Set environment variable <code>AIRFLOW_HOME</code> to e.g.&nbsp;your current directory <code>$(pwd)</code>:</p>
<pre class="{bash}"><code># change the default location ~/airflow if you want:
$ export AIRFLOW_HOME="$(pwd)"</code></pre>
<p>or any other suitable directory.</p>
<p>Next, initialize the database:</p>
<pre class="{bash}"><code>$ airflow initdb</code></pre>
<p>Now start the web server and go to <a href="http://localhost:8080/">localhost:8080</a> to check out the UI:</p>
<pre class="{bash}"><code>$ airflow webserver --port 8080</code></pre>
<p>It should look something like this:</p>
<p><img src="https://airflow.incubator.apache.org/_images/dags.png" style="width: 70%;"></p>
<p>With the web server running workflows can be started from a new terminal window. Open a new terminal, activate the virtual environment and set the environment variable <code>AIRFLOW_HOME</code> for this terminal as well:</p>
<pre class="{bash}"><code>$ source activate airflow-tutorial
$ export AIRFLOW_HOME="$(pwd)"</code></pre>
<p>Make sure that you’re an in the same directory as before when using <code>$(pwd)</code>.</p>
<p>Run a supplied example:</p>
<pre class="{bash}"><code>$ airflow run example_bash_operator runme_0 2017-07-01</code></pre>
<p>And check in the web UI that it has run by going to Browse -&gt; Task Instances.</p>
<p>This concludes all the setting up that you need for this tutorial.</p>
</section>
<section id="tips" class="level4">
<h4 class="anchored" data-anchor-id="tips">Tips</h4>
<ul>
<li>Both Python 2 and 3 are be supported by Airflow. However, some of the lesser used parts (e.g.&nbsp;operators in <code>contrib</code>) might not support Python 3.</li>
<li>For more information on configuration check the sections on <a href="https://airflow.incubator.apache.org/configuration.html">Configuration</a> and <a href="https://airflow.incubator.apache.org/security.html">Security</a> of the Airflow documentation.</li>
<li>Check the <a href="https://github.com/apache/incubator-airflow/tree/master/scripts">Airflow repository</a> for <code>upstart</code> and <code>systemd</code> templates.</li>
<li>Airflow logs extensively, so pick your log folder carefully.</li>
<li>Set the timezone of your production machine to UTC: Airflow assumes it’s UTC.</li>
</ul>
</section>
</section>
<section id="workflows" class="level2">
<h2 class="anchored" data-anchor-id="workflows">2. Workflows</h2>
<p>We’ll create a workflow by specifying actions as a Directed Acyclic Graph (DAG) in Python. The tasks of a workflow make up a Graph; the graph is Directed because the tasks are ordered; and we don’t want to get stuck in an eternal loop so the graph also has to be Acyclic.</p>
<p>The figure below shows an example of a DAG:</p>
<p><img src="https://airflow.incubator.apache.org/_images/subdag_before.png" style="width: 60%;"></p>
<p>The DAG of this tutorial is a bit easier. It will consist of the following tasks:</p>
<ul>
<li>print <code>'hello'</code></li>
<li>wait 5 seconds</li>
<li>print <code>'world</code></li>
</ul>
<p>and we’ll plan daily execution of this workflow.</p>
<section id="create-a-dag-file" class="level4">
<h4 class="anchored" data-anchor-id="create-a-dag-file">Create a DAG file</h4>
<p>Go to the folder that you’ve designated to be your <code>AIRFLOW_HOME</code> and find the DAGs folder located in subfolder <code>dags/</code> (if you cannot find, check the setting <code>dags_folder</code> in <code>$AIRFLOW_HOME/airflow.cfg</code>). Create a Python file with the name <code>airflow_tutorial.py</code> that will contain your DAG. Your workflow will automatically be picked up and scheduled to run.</p>
<p>First we’ll configure settings that are shared by all our tasks. Settings for tasks can be passed as arguments when creating them, but we can also pass a dictionary with default values to the DAG. This allows us to share default arguments for all the tasks in our DAG is the best place to set e.g.&nbsp;the owner and start date of our DAG.</p>
<p>Add the following import and dictionary to <code>airflow_tutorial.py</code> to specify the owner, start time, and retry settings that are shared by our tasks:</p>
</section>
<section id="configure-common-settings" class="level4">
<h4 class="anchored" data-anchor-id="configure-common-settings">Configure common settings</h4>
<div id="1bad21e2" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime <span class="im">as</span> dt</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>default_args <span class="op">=</span> {</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'owner'</span>: <span class="st">'me'</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start_date'</span>: dt.datetime(<span class="dv">2017</span>, <span class="dv">6</span>, <span class="dv">1</span>),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'retries'</span>: <span class="dv">1</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'retry_delay'</span>: dt.timedelta(minutes<span class="op">=</span><span class="dv">5</span>),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These settings tell Airflow that this workflow is owned by <code>'me'</code>, that the workflow is valid since June 1st of 2017, it should not send emails and it is allowed to retry the workflow once if it fails with a delay of 5 minutes. Other common default arguments are email settings on failure and the end time.</p>
</section>
<section id="create-the-dag" class="level4">
<h4 class="anchored" data-anchor-id="create-the-dag">Create the DAG</h4>
<p>We’ll now create a DAG object that will contain our tasks.</p>
<p>Name it <code>airflow_tutorial_v01</code> and pass <code>default_args</code>:</p>
<div id="d2f53f9b" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> airflow <span class="im">import</span> DAG</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> DAG(<span class="st">'airflow_tutorial_v01'</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>         default_args<span class="op">=</span>default_args,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>         schedule_interval<span class="op">=</span><span class="st">'0 * * * *'</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>         ) <span class="im">as</span> dag:</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With <code>schedule_interval='0 * * * *'</code> we’ve specified a run at every hour 0; the DAG will run each day at 00:00. See <a href="https://crontab.guru/#0_*_*_*_*">crontab.guru</a> for help deciphering cron schedule expressions. Alternatively, you can use strings like <code>'@daily'</code> and <code>'@hourly'</code>.</p>
<p>We’ve used a <a href="https://jeffknupp.com/blog/2016/03/07/python-with-context-managers/">context manager</a> to create a DAG (new since 1.8). All the tasks for the DAG should be indented to indicate that they are part of this DAG. Without this context manager you’d have to set the <code>dag</code> parameter for each of your tasks.</p>
<p>Airflow will generate DAG runs from the <code>start_date</code> with the specified <code>schedule_interval</code>. Once a DAG is active, Airflow continuously checks in the database if all the DAG runs have successfully ran since the <code>start_date</code>. Any missing DAG runs are automatically scheduled. When you initialize on 2016-01-04 a DAG with a <code>start_date</code> at 2016-01-01 and a daily <code>schedule_interval</code>, Airflow will schedule DAG runs for all the days between 2016-01-01 and 2016-01-04.</p>
<p>A run starts <em>after</em> the time for the run has passed. The time for which the workflow runs is called the <code>execution_date</code>. The daily workflow for 2016-06-02 runs after 2016-06-02 23:59 and the hourly workflow for 2016-07-03 01:00 starts after 2016-07-03 01:59.</p>
<p>From the ETL viewpoint this makes sense: you can only process the daily data for a day after it has passed. This can, however, ask for some juggling with date for other workflows. For Machine Learning models you may want to use all the data up to a given date, you’ll have to add the <code>schedule_interval</code> to your <code>execution_date</code> somewhere in the workflow logic.</p>
<p>Because Airflow saves all the (scheduled) DAG runs in its database, you should not change the <code>start_date</code> and <code>schedule_interval</code> of a DAG. Instead, up the version number of the DAG (e.g.&nbsp;<code>airflow_tutorial_v02</code>) and avoid running unnecessary tasks by using the web interface or command line tools</p>
<p>Timezones and especially daylight savings can mean trouble when scheduling things, so keep your Airflow machine in UTC. You don’t want to skip an hour because daylight savings kicks in (or out).</p>
</section>
<section id="create-the-tasks" class="level4">
<h4 class="anchored" data-anchor-id="create-the-tasks">Create the tasks</h4>
<p>Tasks are represented by operators that either perform an action, transfer data, or sense if something has been done. Examples of actions are running a bash script or calling a Python function; of transfers are copying tables between databases or uploading a file; and of sensors are checking if a file exists or data has been added to a database.</p>
<p>We’ll create a workflow consisting of three tasks: we’ll print ‘hello’, wait for 10 seconds and finally print ‘world’. The first two are done with the <code>BashOperator</code> and the latter with the <code>PythonOperator</code>. Give each operator an unique task ID and something to do:</p>
<div id="ce2b794c" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> airflow.operators.bash_operator <span class="im">import</span> BashOperator</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> airflow.operators.python_operator <span class="im">import</span> PythonOperator</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> print_world():</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'world'</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    print_hello <span class="op">=</span> BashOperator(task_id<span class="op">=</span><span class="st">'print_hello'</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                               bash_command<span class="op">=</span><span class="st">'echo "hello"'</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    sleep <span class="op">=</span> BashOperator(task_id<span class="op">=</span><span class="st">'sleep'</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                         bash_command<span class="op">=</span><span class="st">'sleep 5'</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    print_world <span class="op">=</span> PythonOperator(task_id<span class="op">=</span><span class="st">'print_world'</span>,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>                                 python_callable<span class="op">=</span>print_world)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note how we can pass bash commands in the <code>BashOperator</code> and that the <code>PythonOperator</code> asks for a Python function that can be called.</p>
<p>Dependencies in tasks are added by setting other actions as upstream (or downstream). Link the operations in a chain so that <code>sleep</code> will be run after <code>print_hello</code> and is followed by <code>print_world</code>; <code>print_hello</code> -&gt; <code>sleep</code> -&gt; <code>print_world</code>:</p>
<div id="0b7024c3" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>print_hello <span class="op">&gt;&gt;</span> sleep <span class="op">&gt;&gt;</span> print_world</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After rearranging the code your final DAG should look something like:</p>
<div id="1217920a" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime <span class="im">as</span> dt</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> airflow <span class="im">import</span> DAG</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> airflow.operators.bash_operator <span class="im">import</span> BashOperator</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> airflow.operators.python_operator <span class="im">import</span> PythonOperator</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_world():</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'world'</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>default_args <span class="op">=</span> {</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'owner'</span>: <span class="st">'me'</span>,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start_date'</span>: dt.datetime(<span class="dv">2017</span>, <span class="dv">6</span>, <span class="dv">1</span>),</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'retries'</span>: <span class="dv">1</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'retry_delay'</span>: dt.timedelta(minutes<span class="op">=</span><span class="dv">5</span>),</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> DAG(<span class="st">'airflow_tutorial_v01'</span>,</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>         default_args<span class="op">=</span>default_args,</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>         schedule_interval<span class="op">=</span><span class="st">'0 * * * *'</span>,</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>         ) <span class="im">as</span> dag:</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    print_hello <span class="op">=</span> BashOperator(task_id<span class="op">=</span><span class="st">'print_hello'</span>,</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>                               bash_command<span class="op">=</span><span class="st">'echo "hello"'</span>)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    sleep <span class="op">=</span> BashOperator(task_id<span class="op">=</span><span class="st">'sleep'</span>,</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>                         bash_command<span class="op">=</span><span class="st">'sleep 5'</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    print_world <span class="op">=</span> PythonOperator(task_id<span class="op">=</span><span class="st">'print_world'</span>,</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>                                 python_callable<span class="op">=</span>print_world)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>print_hello <span class="op">&gt;&gt;</span> sleep <span class="op">&gt;&gt;</span> print_world</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="test-the-dag" class="level4">
<h4 class="anchored" data-anchor-id="test-the-dag">Test the DAG</h4>
<p>First check that DAG file contains valid Python code by executing the file with Python:</p>
<pre class="{bash}"><code>$ python airflow_tutorial.py</code></pre>
<p>You can manually test a single task for a given <code>execution_date</code> with <code>airflow test</code>:</p>
<pre class="{bash}"><code>$ airflow test airflow_tutorial_v01 print_world 2016-07-01</code></pre>
<p>This runs the task locally as if it was for 2017-07-01, ignoring other tasks and without communicating to the database.</p>
</section>
<section id="activate-the-dag" class="level4">
<h4 class="anchored" data-anchor-id="activate-the-dag">Activate the DAG</h4>
<p>Now that you’re confident that your dag works, turn on the DAG in the web UI and sit back while Airflow starts backfilling the dag runs!</p>
</section>
<section id="tips-1" class="level4">
<h4 class="anchored" data-anchor-id="tips-1">Tips</h4>
<ul>
<li>Make your DAGs idempotent: rerunning them should give the game results.</li>
<li>Use the the cron notation for <code>schedule_interval</code> instead of <code>@daily</code> and <code>@hourly</code>. <code>@daily</code> and <code>@hourly</code> always run after respectively midnight and the full hour, regardless of the hour/minute specified.</li>
<li>Manage your connections and secrets with the <a href="https://airflow.incubator.apache.org/configuration.html#connections">Connections</a> and/or <a href="https://airflow.incubator.apache.org/ui.html#variable-view">Variables</a>.</li>
</ul>
</section>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">3. Exercises</h2>
<p>You now know the basics of setting up Airflow, creating a DAG and turning it on; time to go deeper!</p>
<ul>
<li>Change the interval to every 30 minutes.</li>
<li>Use a sensor to add a delay of 5 minutes before starting.</li>
<li>Implement templating for the <code>BashOperator</code>: print the <code>execution_date</code> instead of <code>'hello'</code> (check out the <a href="https://airflow.incubator.apache.org/tutorial.html#templating-with-jinja">original tutorial</a> and the <a href="https://github.com/apache/incubator-airflow/blob/master/airflow/example_dags/example_bash_operator.py">example DAG</a>).</li>
<li>Use templating for the <code>PythonOperator</code>: print the <code>execution_date</code> with one hour added in the function <code>print_world()</code> (check out the documentation of the <a href="https://airflow.incubator.apache.org/code.html#airflow.operators.PythonOperator"><code>PythonOperator</code></a>).</li>
</ul>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">4. Resources</h2>
<ul>
<li><a href="https://pythonhosted.org/airflow/tutorial.html">The official Airflow tutorial</a>: showing a bit more in-depth templating magic.</li>
<li><a href="https://gtoonstra.github.io/etl-with-airflow/">ETL best practices with Airflow</a>: good best practices to follow when using Airflow.</li>
<li><a href="https://medium.com/handy-tech/airflow-tips-tricks-and-pitfalls-9ba53fba14eb">Airflow: Tips, Tricks, and Pitfalls</a>: more explanations to help you grok Airflow.</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/hgrif\.github\.io\/hgrif\.github\.io-src\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>